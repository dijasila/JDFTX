<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JDFTx: Phonon dispersion</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="jdftx-55.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">JDFTx
   &#160;<span id="projectnumber">1.7.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('PhononDispersion.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title"><a class="el" href="classPhonon.html" title="Calculate phonon dispersion, free energies and electron-phonon matrix elements.">Phonon</a> dispersion </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="PhononDispersion.png" alt=""/>
</div>
<p>This tutorial will introduce the calculation of phonon dispersion and vibrational free energies of periodic systems within JDFTx. Displacing an atom from their equilibrium positions in a molecule generates restoring forces on all atoms (within some range), which is represented by the force matrix of the system. The eigenvalues and eigenvectors of this matrix (after accounting for atom masses) represent the vibrational frequencies and normal modes of the molecule. The <a class="el" href="FreeEnergy.html">Free energy: Vibrations</a> tutorial introduced the calculation of vibrational properties of molecules using the <a class="el" href="CommandVibrations.html">vibrations</a> command.</p>
<p>In periodic systems, the force matrix has a finite range that extends beyond a single unit cell of the system. In this case, Bloch's theorem implies that the eigenvectors are waves of atom vibrations, called phonons, and the eigenvalues exhibit a band structure term the phonon dispersion. Calculating forces due to atom perturbations beyond the range of one unit cell requires performing supercell calculations and mapping the resulting properties back to the unit cell. The <a class="el" href="CommandVibrations.html">vibrations</a> command within jdftx only deals with unit cell calculations and that suffices for molecules. For solids, the phonon executable handles constructing supercells, performing perturbed calculations and mapping the so-calculated phonon properties back to the original unit cell.</p>
<p>Let's start with the silicon calculations from the <a class="el" href="BandStructure.html">Band structure calculations</a> tutorial (which we also used for the <a class="el" href="SeparatedBands.html">Separated bands</a> Wannier tutorial). Remember to run the total energy calculation, construct the k-point path, and review the electronic band-structure calculation and plotting.</p>
<p>First, we set up a input file for phonon: </p><pre class="fragment">#Save the following to phonon.in
include totalE.in          #Full specification of the unit cell calculation
initial-state totalE.$VAR  #Start from converged unit cell state
dump-only                  #Don't reconverge unit cell state

phonon supercell 2 2 2     #Calculate force matrix in a 2x2x2 supercell
</pre><p> and run it with: </p><pre class="fragment">mpirun -n 4 phonon -i phonon.in | tee phonon.out
</pre><p> This may take several minutes, so run the above command and then follow along below as we examine the output generated. Once again, note that we use the executable phonon, separate from jdftx. The input file is extremely simple, relying on totalE.in for the entire specification of the unit cell calculation and the corresponding converged unit cell results (totalE.$VAR).</p>
<p>The only addition is the <a class="el" href="CommandPhonon.html">phonon</a> command, for which the only required argument is the supercell size in which to calculate the force matrix. The supercell size <em>must</em> be a factor of the k-point folding: since we have 8x8x8 folding in this case, only 1, 2, 4 and 8 are acceptable for each dimension of the supercell. Note that the calculation will be substantially more expensive as the supercell size is increased.</p>
<p>Now examine the output in (or that is being written to) phonon.out. After listing all the commands (including default ones), the usual initialization of a unit cell calculation follows under the heading &ldquo;Unit cell calculation.&rdquo; This part ends on the energy evaluation in the unit cell at a fixed state (corresponding to <a class="el" href="CommandDumpOnly.html">dump-only</a>).</p>
<p>Next, phonon constructs the supercell and determines its symmetries. It figures out all the atom displacements necessary to generate the force matrix: 2 atoms/cell x 3 Cartesian directions x 2 signs for central difference derivative = 12 for this example, and then finds the number of symmetry-irreducible perturbations, which happens to be just 1 in this case!</p>
<p>Then, for each symmetry-irreducible perturbation, it runs a supercell calculation with atom displaced (by dr = 0.01 bohrs by default, see <a class="el" href="CommandPhonon.html">phonon</a> to change this) under the heading &ldquo;Perturbed supercell calculation X of N.&rdquo; The output format for each such calculation is also the usual JDFTx initialization followed by <a class="el" href="classSCF.html" title="Self-Consistent Field method for converging electronic state.">SCF</a> (or ElecMinimize), but note that the lattice vectors are all twice as large, the bands and basis 8 times larger, while the k-point folding is halved, because this is a 2x2x2 supercell calculation.</p>
<p>At the end of each supercell calculation, phonon reports the energy and force change due to the perturbation per unit cell. Always make sure that these are one-two orders of magnitude larger than the convergence thresholds, either by adjusting those thresholds, or by adjusting dr in the <a class="el" href="CommandPhonon.html">phonon</a> command.</p>
<p>After all the supercell calculations, phonon collects force matrix contributions from each and outputs this to the binary totalE.phononOmegaSq file (which we will use below). It also outputs the text file totalE.phononCellMap, which lists the order of neighboring unit cells for the force matrix output (in exactly the same format as the wannier.mlwfCellMap encountered in the <a class="el" href="SeparatedBands.html">Separated bands</a> Wannier tutorial). Meanwhile, totalE.phononBasis lists the order of atom perturbations in the phonon force matrix. The totalE.phononHsub binary file contains electron-phonon matrix elements, which we will not discuss in this tutorial.</p>
<p>The code ends with a summary of the zero-point energy and vibrational free energy contributions, in exactly the same format as the output of the <a class="el" href="CommandVibrations.html">vibrations</a> command, except it is now the (free-)energy contributions per unit cell of a periodic system. Note that phonon accounts for 3D periodicity for the Si example here, but will automatically switch to 2D or 1D periodicity, as appropriate, based on the geometry specified in the <a class="el" href="CommandCoulombInteraction.html">coulomb-interaction</a> command.</p>
<p>Finally, we will calculate and plot the phonon dispersion from the force matrix output using this python script: </p><pre class="fragment">#Save the following to PhononDispersion.py:
import numpy as np
from scipy.interpolate import interp1d

#Read the phonon cell map and force matrix:
cellMap = np.loadtxt("totalE.phononCellMap")[:,0:3].astype(int)
forceMatrix = np.fromfile("totalE.phononOmegaSq", dtype=np.float64)
nCells = cellMap.shape[0]
nModes = int(np.sqrt(forceMatrix.shape[0] / nCells))
forceMatrix = np.reshape(forceMatrix, (nCells,nModes,nModes))

#Read the k-point path:
kpointsIn = np.loadtxt('bandstruct.kpoints', skiprows=2, usecols=(1,2,3))
nKin = kpointsIn.shape[0]
#--- Interpolate to a 10x finer k-point path:
nInterp = 10
xIn = np.arange(nKin)
x = (1./nInterp)*np.arange(1+nInterp*(nKin-1)) #same range with 10x density
kpoints = interp1d(xIn, kpointsIn, axis=0)(x)
nK = kpoints.shape[0]

#Calculate dispersion from force matrix:
#--- Fourier transform from real to k space:
forceMatrixTilde = np.tensordot(np.exp((2j*np.pi)*np.dot(kpoints,cellMap.T)), forceMatrix, axes=1)
#--- Diagonalize:
omegaSq, normalModes = np.linalg.eigh(forceMatrixTilde)

#Plot phonon dispersion:
import matplotlib.pyplot as plt
meV = 1e-3/27.2114
plt.plot(np.sqrt(omegaSq)/meV)
plt.xlim([0,nK-1])
plt.ylim([0,None])
plt.ylabel("Phonon energy [meV]")
#--- If available, extract k-point labels from bandstruct.plot:
try:
    import subprocess as sp
    kpathLabels = sp.check_output(['awk', '/set xtics/ {print}', 'bandstruct.plot']).split()
    kpathLabelText = [ label.split('"')[1] for label in kpathLabels[3:-2:2] ]
    kpathLabelPos = [ nInterp*int(pos.split(',')[0]) for pos in kpathLabels[4:-1:2] ]
    plt.xticks(kpathLabelPos, kpathLabelText)
except:
    print ('Warning: could not extract labels from bandstruct.plot')
plt.show()
</pre><p> Note that the overall strategy is exactly analogous to generating the electronic band structure from the Wannier Hamiltonian output. Using information from the cell map, we transform the force matrix to k space and diagonalize it to get the square of the phonon frequencies. Most of the lines of code above deal with input/output and beautifying the plot.</p>
<p>Running "python PhononDispersion.py" produces the phonon dispersion curves (or band structure) shown below and at the top of this page:</p>
<div class="image">
<img src="PhononDispersion.png" alt=""/>
</div>
<p>Note that the phonon energies increase linearly from zero near the Gamma point, rather than quadratically as the electron energies do in band structure plots, because the phonon energy is the square root of the diagonalized quantity. This results in finite group velocities (the sound speeds) of phonons near k=0. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
</div>
</body>
</html>
